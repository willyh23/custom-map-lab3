<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <title>Capitol Hill Pedestrian Safety</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #side-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 320px;
      max-height: 100vh;
      background-color: rgba(255, 255, 255, 0.95);
      overflow-y: auto;
      padding: 20px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      z-index: 1;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      z-index: 0;
    }

    button {
      margin-bottom: 10px;
    }

    table {
      border-collapse: collapse;
      border-spacing: 0;
      width: 100%;
      border: 1px solid #ddd;
    }

    th, td {
      text-align: left;
      padding: 16px;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    @media (max-width: 1024px) {
      #side-panel {
      display: none;
      }
    } 
  </style>
</head>
<body>
  <main>
    <div id="side-panel">
       <div id="legend">
       <h3>Legend</h3>
       <p><span style="background:#ff0000; border-radius:50%; width:10px; height:10px; display:inline-block;"></span> Traffic Signal</p>
       <p><span style="background:#457b9d; width:20px; height:10px; display:inline-block;"></span> Crosswalk</p>
    </div>
      <h1>Capitol Hill Pedestrian Safety</h1>
      <h2>Traffic Signals</h2>
      <button>Sort by ID</button>
      <table>
        <tr>
          <th>id</th>
          <th>coordinates</th>
        </tr>
      </table>
    </div>
    <div id="map"></div>
  </main>

  <script>
    const map = new maplibregl.Map({
      container: 'map',
      center: [-122.320, 47.620],
      zoom: 15,
      style: 'https://api.maptiler.com/maps/streets/style.json?key=Wsr8XjewtXxNYNQu4N6O'
    });

    async function geojsonFetch() {
      let response, signals, crosswalks;

      response = await fetch('assets/trafficsignals_capitol hill.geojson');
      signals = await response.json();

      response = await fetch('assets/crosswalks_capitol hill.geojson');
      crosswalks = await response.json();

      map.on('load', () => {
        // Traffic signals layer
        map.addSource('traffic-signals', {
          type: 'geojson',
          data: signals
        });

        map.addLayer({
          id: 'traffic-signals-layer',
          type: 'circle',
          source: 'traffic-signals',
          paint: {
            'circle-radius': [
              'interpolate',
              ['linear'],
              ['zoom'],
              12, 5,
              16, 10
            ],
            'circle-color': '#e63946'
         }
        });

        // Crosswalks layer
        map.addSource('crosswalks', {
          type: 'geojson',
          data: crosswalks
        });

        map.addLayer({
          id: 'crosswalks-layer',
          type: 'line',
          source: 'crosswalks',
          paint: {
            'line-width': [
              'interpolate',
              ['linear'],
              ['zoom'],
              12, 2,
              16, 6
            ],
            'line-color': '#457b9d'
          }
        });
      });

      // Populate table with traffic signal data
      const table = document.getElementsByTagName("table")[0];
      const rows = [];

      for (let i = 0; i < signals.features.length; i++) {
        const row = document.createElement("tr");
        const cell1 = document.createElement("td");
        const cell2 = document.createElement("td");

        cell1.innerHTML = signals.features[i].properties.id || `signal-${i}`;
        cell2.innerHTML = signals.features[i].geometry.coordinates.join(', ');

        row.appendChild(cell1);
        row.appendChild(cell2);
        rows.push(row);
      }

      // Shuffle the rows array
      rows.sort(() => Math.random() - 0.5);

      // Insert shuffled rows into the table
      for (let row of rows) {
        table.appendChild(row);
      }
    }

    geojsonFetch();

    let popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    map.on('mousemove', 'traffic-signals-layer', (e) => {
      const coords = e.features[0].geometry.coordinates;
      const id = e.features[0].properties.id || 'Unknown Signal';

      popup.setLngLat(coords)
           .setHTML(`<strong>Traffic Signal</strong><br>ID: ${id}<br>${coords.join(', ')}`)
           .addTo(map);
    });

    map.on('mouseleave', 'traffic-signals-layer', () => {
      popup.remove();
    });

    map.on('mousemove', 'crosswalks-layer', (e) => {
      const coords = e.lngLat;

      popup.setLngLat(coords)
           .setHTML(`<strong>Crosswalk</strong>`)
           .addTo(map);
    });

    map.on('mouseleave', 'crosswalks-layer', () => {
      popup.remove();
    });

    // Sort table by ID
    const btn = document.querySelector("button");
    btn.addEventListener('click', () => {
       const table = document.getElementsByTagName("table")[0];
       const rowsArray = Array.from(table.rows).slice(1); // skip header row

       rowsArray.sort((a, b) => {
         const idA = a.cells[0].innerText;
         const idB = b.cells[0].innerText;

         const numA = parseInt(idA.replace("signal-", ""));
         const numB = parseInt(idB.replace("signal-", ""));

         return numA - numB;
       });

      // Re-append sorted rows
      for (let row of rowsArray) {
        table.appendChild(row);
      }
    });
  </script>
</body>
</html>
